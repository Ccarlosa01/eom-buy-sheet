<script>
async function uploadInventory(){
  const f = $("file").files[0];
  if (!f) return alert("Choose an Excel file first.");

  const fileName = f.name.toLowerCase();
  if (!fileName.endsWith(".xlsx") && !fileName.endsWith(".xls")) {
    return alert("Please upload an Excel file (.xlsx or .xls).");
  }

  // 1) Update UI and allow repaint before heavy parsing
  $("uploadMsg").innerHTML = "<small>Reading file...</small>";
  await new Promise(r => setTimeout(r, 0)); // ✅ lets the DOM repaint

  try {
    // 2) Read file bytes (fast)
    const buf = await f.arrayBuffer();

    // 3) Parse workbook (can be slow / CPU heavy)
    $("uploadMsg").innerHTML = "<small>Parsing Excel (this can take a moment)...</small>";
    await new Promise(r => setTimeout(r, 0)); // ✅ repaint before parse

    const wb = XLSX.read(buf, { type: "array" });

    const firstSheetName = wb.SheetNames?.[0];
    if (!firstSheetName) throw new Error("No worksheets found in this file.");

    const ws = wb.Sheets[firstSheetName];
    if (!ws) throw new Error("Worksheet could not be read.");

    // 4) Extract rows
    $("uploadMsg").innerHTML = "<small>Extracting Item No. + Description...</small>";
    await new Promise(r => setTimeout(r, 0));

    const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

    const items = [];
    const seen = new Set();

    for (const r of rows) {
      const productId = String(
        r["Item No."] ?? r["Item No"] ?? r["ItemNo"] ?? r["Item #"] ?? ""
      ).trim();

      const productDescription = String(
        r["Description"] ?? r["Desc"] ?? ""
      ).trim();

      if (!productId || !productDescription) continue;
      if (seen.has(productId)) continue;

      seen.add(productId);
      items.push({ productId, productDescription });
    }

    if (!items.length) {
      $("uploadMsg").innerHTML =
        "<small class='badge bad'>No valid rows found. Confirm columns are named 'Item No.' and 'Description'.</small>";
      return;
    }

    // 5) Upload to backend
    $("uploadMsg").innerHTML = `<small>Uploading ${items.length} items...</small>`;
    const res = await apiPost("/manager/inventory/upload", { items }, true);

    $("uploadMsg").innerHTML =
      `<small class="badge ok">Uploaded ${res.count} items successfully</small>`;

  } catch (err) {
    console.error("Inventory upload error:", err);

    // If XLS parsing fails, very old/corrupt .xls is common
    const msg = (err && err.message) ? err.message : String(err);
    $("uploadMsg").innerHTML =
      `<small class="badge bad">Error: ${msg}. If this is a legacy .xls, open it in Excel and “Save As” .xlsx, then retry.</small>`;
  }
}
</script>
