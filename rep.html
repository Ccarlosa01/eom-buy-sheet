<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rep Portal</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="nav">
    <div class="brand">Rep Portal</div>
    <div class="flex right">
      <span id="repWho" class="mono"></span>
      <button id="logoutBtn" class="hidden">Logout</button>
      <a href="index.html">Home</a>
    </div>
  </div>

  <div class="container">

    <!-- AUTH -->
    <div id="authCard" class="card">
      <h2>Sign in</h2>
      <div class="row">
        <div class="card" style="flex:1;min-width:280px">
          <h2>Login</h2>
          <div class="flex">
            <input id="loginUsername" placeholder="username (e.g., jsmith)" />
            <input id="loginPin" placeholder="PIN" inputmode="numeric" />
            <button class="primary" id="loginBtn">Login</button>
          </div>
        </div>

        <div class="card" style="flex:1;min-width:280px">
          <h2>Create account</h2>
          <div class="flex">
            <input id="firstName" placeholder="First name" />
            <input id="lastName" placeholder="Last name" />
            <input id="phone" placeholder="Cell phone" />
          </div>

          <div style="margin-top:10px">
            <label><small><b>Vendor</b> (select your company)</small></label>
            <select id="vendorSelect" style="width:100%;margin-top:6px;"></select>

            <div id="vendorOtherWrap" class="hidden" style="margin-top:10px">
              <label><small><b>If Other, type your vendor</b></small></label>
              <input id="vendorOther" placeholder="Type vendor name..." style="width:100%;margin-top:6px;" />
            </div>

            <small>Donâ€™t see your vendor? Choose <b>Other</b>.</small>
          </div>

          <div class="flex" style="margin-top:10px">
            <input id="pin" placeholder="Choose PIN (4+ digits)" inputmode="numeric" />
            <button class="primary" id="signupBtn">Create account</button>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appCard" class="card hidden">
      <h2>New Batch</h2>

      <div class="card">
        <h2>Add items</h2>
        <div class="flex">
          <input id="searchQ" placeholder="Search by description..." style="min-width:320px" />
          <button id="searchBtn">Search</button>
          <span id="searchStatus"></span>
        </div>
        <div id="searchResults" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>Batch Lines</h2>
        <div class="flex">
          <button id="submitBatchBtn" class="primary">Submit Batch</button>
          <button id="clearBatchBtn" class="danger">Clear</button>
          <small id="batchMsg"></small>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table class="table">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Description</th>
                <th>Units/Case</th>
                <th>Permanent Price Increase?</th>

                <th id="h_m0_case"></th>
                <th id="h_m0_qty"></th>

                <th id="h_m1_case"></th>
                <th id="h_m1_qty"></th>

                <th id="h_m2_case"></th>
                <th id="h_m2_qty"></th>

                <th id="h_m3_case"></th>
                <th id="h_m3_qty"></th>

                <th></th>
              </tr>
            </thead>
            <tbody id="batchBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script src="app.js"></script>
<script>

const state = { vendors: [], batch: [] };

function monthLabel(d) {
  return d.toLocaleString(undefined, { month: "short", year: "numeric" });
}

function setBatchMonthHeaders() {
  const now = new Date();
  const dates = [
    new Date(now.getFullYear(), now.getMonth(), 1),
    new Date(now.getFullYear(), now.getMonth()+1, 1),
    new Date(now.getFullYear(), now.getMonth()+2, 1),
    new Date(now.getFullYear(), now.getMonth()+3, 1)
  ];

  const labels = dates.map(monthLabel);

  document.getElementById("h_m0_case").textContent = `${labels[0]} Case Deal`;
  document.getElementById("h_m0_qty").textContent  = `${labels[0]} Case Qty`;

  document.getElementById("h_m1_case").textContent = `${labels[1]} Case Deal`;
  document.getElementById("h_m1_qty").textContent  = `${labels[1]} Case Qty`;

  document.getElementById("h_m2_case").textContent = `${labels[2]} Case Deal`;
  document.getElementById("h_m2_qty").textContent  = `${labels[2]} Case Qty`;

  document.getElementById("h_m3_case").textContent = `${labels[3]} Case Deal`;
  document.getElementById("h_m3_qty").textContent  = `${labels[3]} Case Qty`;
}

function vendorUI(){
  const val = $("vendorSelect").value;
  $("vendorOtherWrap").classList.toggle("hidden", val !== "__OTHER__");
}

async function loadVendors(){
  const sel = $("vendorSelect");
  sel.innerHTML = "<option value=''>Loading...</option>";

  try {
    const data = await apiPost("/vendors/list", {}, false);
    state.vendors = data.vendors || [];
  } catch {
    state.vendors = [];
  }

  sel.innerHTML = "<option value=''>Select your vendor...</option>";

  state.vendors.forEach(v => {
    const o = document.createElement("option");
    o.value = v.vendorId;
    o.textContent = v.vendorName;
    sel.appendChild(o);
  });

  const other = document.createElement("option");
  other.value = "__OTHER__";
  other.textContent = "Other (add new)";
  sel.appendChild(other);
}

function renderAuthState(){
  const user = getUser();
  const loggedIn = !!user && !!getToken();
  $("authCard").classList.toggle("hidden", loggedIn);
  $("appCard").classList.toggle("hidden", !loggedIn);
  $("logoutBtn").classList.toggle("hidden", !loggedIn);
  $("repWho").textContent = loggedIn ? `${user.username}` : "";
}

async function doSignup(){
  try {
    const vSel = $("vendorSelect").value;
    const payload = {
      firstName: $("firstName").value.trim(),
      lastName: $("lastName").value.trim(),
      phone: $("phone").value.trim(),
      pin: $("pin").value.trim()
    };

    if (vSel === "__OTHER__") {
      payload.vendorName = $("vendorOther").value.trim();
      if (!payload.vendorName) return alert("Please type your vendor.");
    } else {
      payload.vendorId = vSel;
      if (!payload.vendorId) return alert("Please select your vendor.");
    }

    const res = await apiPost("/rep/signup", payload, false);
    saveUser(res.user);
    saveToken(res.token);
    alert(`Account created! Username: ${res.user.username}`);
    renderAuthState();
  } catch(e){
    alert(e.message);
  }
}

async function doLogin(){
  try {
    const res = await apiPost("/auth/login", {
      username: $("loginUsername").value.trim(),
      pin: $("loginPin").value.trim()
    }, false);
    saveUser(res.user);
    saveToken(res.token);
    renderAuthState();
  } catch(e){
    alert(e.message);
  }
}

function logout(){
  clearToken();
  state.batch = [];
  renderBatch();
  renderAuthState();
}

$("signupBtn").onclick = doSignup;
$("loginBtn").onclick = doLogin;
$("logoutBtn").onclick = logout;
$("vendorSelect").addEventListener("change", vendorUI);

setBatchMonthHeaders();
loadVendors();
renderAuthState();

</script>
</body>
</html>
