<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rep Portal</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="nav">
    <div class="brand">Rep Portal</div>
    <div class="flex right">
      <span id="repWho" class="mono"></span>
      <button id="logoutBtn" class="hidden">Logout</button>
      <a href="index.html">Home</a>
    </div>
  </div>

  <div class="container">

    <!-- AUTH -->
    <div id="authCard" class="card">
      <h2>Sign in</h2>
      <div class="row">
        <div class="card" style="flex:1;min-width:280px">
          <h2>Login</h2>
          <div class="flex">
            <input id="loginUsername" placeholder="username (e.g., jsmith2)" />
            <input id="loginPin" placeholder="PIN" inputmode="numeric" />
            <button class="primary" id="loginBtn">Login</button>
          </div>
          <small>Username = first initial + last name (duplicates get a number).</small>
        </div>

        <div class="card" style="flex:1;min-width:280px">
          <h2>Create account</h2>
          <div class="flex">
            <input id="firstName" placeholder="First name" />
            <input id="lastName" placeholder="Last name" />
            <input id="phone" placeholder="Cell phone" />
          </div>

          <!-- ✅ Vendor selection -->
          <div style="margin-top:10px">
            <label for="vendorSelect"><small><b>Vendor</b> (select your company)</small></label>
            <select id="vendorSelect" style="width:100%; margin-top:6px;"></select>

            <div id="vendorOtherWrap" class="hidden" style="margin-top:10px">
              <label for="vendorOther"><small><b>If Other, type your vendor</b></small></label>
              <input id="vendorOther" placeholder="Type your vendor name..." style="width:100%; margin-top:6px;" />
            </div>

            <small>Don’t see your vendor? Choose <b>Other</b> and type it in.</small>
          </div>

          <div class="flex" style="margin-top:10px">
            <input id="pin" placeholder="Choose PIN (4+ digits)" inputmode="numeric" />
            <button class="primary" id="signupBtn">Create account</button>
          </div>
          <small>After signup you’ll see your exact username (e.g., jsmith2).</small>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appCard" class="card hidden">
      <h2>New Batch</h2>

      <div class="card">
        <h2>Add items</h2>
        <div class="flex">
          <input id="searchQ" placeholder="Search by description..." style="min-width:320px" />
          <button id="searchBtn">Search</button>
          <span id="searchStatus"><small></small></span>
        </div>
        <div id="searchResults" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>Batch Lines</h2>
        <div class="flex">
          <button id="submitBatchBtn" class="primary">Submit Batch</button>
          <button id="clearBatchBtn" class="danger">Clear</button>
          <small id="batchMsg"></small>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table class="table" id="batchTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Description</th>
                <th>Units/Case</th>
                <th>Permanent Price Increase?</th>

                <th id="h_m0_case"></th>
                <th id="h_m0_qty"></th>

                <th id="h_m1_case"></th>
                <th id="h_m1_qty"></th>

                <th id="h_m2_case"></th>
                <th id="h_m2_qty"></th>

                <th id="h_m3_case"></th>
                <th id="h_m3_qty"></th>

                <th></th>
              </tr>
            </thead>
            <tbody id="batchBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script src="app.js"></script>
<script>
  const state = { vendors: [], batch: [] };

  /* -------- Month headers -------- */
  function monthLabel(d) {
    return d.toLocaleString(undefined, { month: "short", year: "numeric" });
  }
  function setBatchMonthHeaders() {
    const now = new Date();
    const m0 = new Date(now.getFullYear(), now.getMonth(), 1);
    const m1 = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    const m2 = new Date(now.getFullYear(), now.getMonth() + 2, 1);
    const m3 = new Date(now.getFullYear(), now.getMonth() + 3, 1);
    const labels = [monthLabel(m0), monthLabel(m1), monthLabel(m2), monthLabel(m3)];

    const set = (id, text) => {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    };

    set("h_m0_case", `${labels[0]} Case Deal`);
    set("h_m0_qty",  `${labels[0]} Case Qty`);
    set("h_m1_case", `${labels[1]} Case Deal`);
    set("h_m1_qty",  `${labels[1]} Case Qty`);
    set("h_m2_case", `${labels[2]} Case Deal`);
    set("h_m2_qty",  `${labels[2]} Case Qty`);
    set("h_m3_case", `${labels[3]} Case Deal`);
    set("h_m3_qty",  `${labels[3]} Case Qty`);
  }

  /* -------- Vendor dropdown -------- */
  function vendorUI(){
    const val = $("vendorSelect").value;
    const isOther = (val === "__OTHER__");
    $("vendorOtherWrap").classList.toggle("hidden", !isOther);
    if (!isOther) $("vendorOther").value = "";
  }

  async function loadVendors(){
    const sel = $("vendorSelect");
    sel.innerHTML = "";
    const loading = document.createElement("option");
    loading.value = "";
    loading.textContent = "Loading vendors...";
    sel.appendChild(loading);

    try {
      const data = await apiPost("/vendors/list", {}, false);
      state.vendors = data.vendors || [];
    } catch {
      state.vendors = [];
    }

    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Select your vendor...";
    sel.appendChild(opt0);

    for (const v of state.vendors) {
      const o = document.createElement("option");
      o.value = v.vendorId;
      o.textContent = v.vendorName;
      sel.appendChild(o);
    }

    const other = document.createElement("option");
    other.value = "__OTHER__";
    other.textContent = "Other (add new)";
    sel.appendChild(other);

    vendorUI();
  }

  /* -------- Auth state -------- */
  function renderAuthState(){
    const user = getUser();
    const loggedIn = !!user && !!getToken();

    $("authCard").classList.toggle("hidden", loggedIn);
    $("appCard").classList.toggle("hidden", !loggedIn);
    $("logoutBtn").classList.toggle("hidden", !loggedIn);

    $("repWho").textContent = loggedIn ? `${user.username}${user.repId ? " ("+user.repId+")" : ""}` : "";
  }

  function logout(){
    clearToken();
    state.batch = [];
    renderBatch();
    $("batchMsg").textContent = "";
    $("searchResults").innerHTML = "";
    $("searchStatus").innerHTML = "<small></small>";
    $("searchQ").value = "";
    renderAuthState();
  }

  /* -------- Batch UI -------- */
  function addToBatch(item){
    if (state.batch.some(x => x.productId === item.productId)) return;
    state.batch.push({
      productId: item.productId,
      productDescription: item.productDescription,
      unitsPerCase: "",
      permanentIncrease: false,

      cur_unitCaseCost: "",
      cur_qtyCaseDeal: "",

      m1_unitCaseCost: "",
      m1_qtyCaseDeal: "",

      m2_unitCaseCost: "",
      m2_qtyCaseDeal: "",

      m3_unitCaseCost: "",
      m3_qtyCaseDeal: ""
    });
    renderBatch();
  }

  function renderBatch(){
    const tb = $("batchBody");
    tb.innerHTML = "";
    state.batch.forEach((ln, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${ln.productId}</td>
        <td>${ln.productDescription}</td>

        <td><input value="${ln.unitsPerCase}" data-k="unitsPerCase" data-i="${idx}" style="min-width:110px"></td>

        <td style="text-align:center">
          <input type="checkbox" ${ln.permanentIncrease ? "checked":""} data-k="permanentIncrease" data-i="${idx}">
        </td>

        <td><input value="${ln.cur_unitCaseCost}" data-k="cur_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.cur_qtyCaseDeal}" data-k="cur_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><input value="${ln.m1_unitCaseCost}" data-k="m1_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.m1_qtyCaseDeal}" data-k="m1_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><input value="${ln.m2_unitCaseCost}" data-k="m2_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.m2_qtyCaseDeal}" data-k="m2_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><input value="${ln.m3_unitCaseCost}" data-k="m3_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.m3_qtyCaseDeal}" data-k="m3_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><button class="danger" data-del="${idx}">Remove</button></td>
      `;
      tb.appendChild(tr);
    });
  }

  function wireBatchHandlers(){
    $("batchBody").addEventListener("input", (e) => {
      const t = e.target;
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if (!Number.isInteger(i) || !k) return;
      state.batch[i][k] = t.value;
    });

    $("batchBody").addEventListener("change", (e) => {
      const t = e.target;
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if (!Number.isInteger(i) || !k) return;
      if (t.type === "checkbox") state.batch[i][k] = t.checked;
    });

    $("batchBody").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;
      const i = Number(btn.dataset.del);
      state.batch.splice(i, 1);
      renderBatch();
    });
  }

  /* -------- Dynamic search -------- */
  let searchTimer = null;
  let searchAbort = null;

  function debounceSearch(fn, delay = 250) {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(fn, delay);
  }

  async function searchInventory(dynamic = false){
    const q = $("searchQ").value.trim();

    if (q.length < 2) {
      $("searchStatus").innerHTML = dynamic ? "<small>Type 2+ characters…</small>" : "<small></small>";
      $("searchResults").innerHTML = "";
      return;
    }

    if (searchAbort) searchAbort.abort();
    searchAbort = new AbortController();

    $("searchStatus").innerHTML = "<small>Searching…</small>";

    try {
      const headers = { "Content-Type": "application/json" };
      const t = getToken();
      if (t) headers["Authorization"] = "Bearer " + t;

      const res = await fetch(API_BASE + "/inventory/search", {
        method: "POST",
        headers,
        body: JSON.stringify({ q }),
        signal: searchAbort.signal
      });

      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Search failed");

      const items = data.items || [];
      const div = $("searchResults");
      div.innerHTML = "";

      if (!items.length) {
        div.innerHTML = "<small>No matches.</small>";
        $("searchStatus").innerHTML = "<small>0 result(s)</small>";
        return;
      }

      items.forEach(it => {
        const row = document.createElement("div");
        row.className = "card";
        row.style.padding = "10px";
        row.style.marginBottom = "8px";
        row.innerHTML = `
          <div class="flex">
            <div class="mono">${it.productId}</div>
            <div style="flex:1">${it.productDescription}</div>
            <button class="primary">Add</button>
          </div>`;

        // ✅ Optional UX: clear results after adding
        row.querySelector("button").onclick = () => {
          addToBatch(it);
          $("searchResults").innerHTML = "";
          $("searchStatus").innerHTML = "<small>Added.</small>";
          $("searchQ").value = "";
          $("searchQ").focus();
        };

        div.appendChild(row);
      });

      $("searchStatus").innerHTML = `<small>${items.length} result(s)</small>`;
    } catch (err) {
      if (err.name === "AbortError") return;
      $("searchStatus").innerHTML = `<small class="badge bad">${err.message}</small>`;
    }
  }

  /* -------- Auto-load latest submitted batch on login -------- */
  async function loadLatestBatchIntoTable() {
    try {
      const res = await apiPost("/rep/batch/latest", {}, true);
      if (!res.hasBatch) return;

      state.batch = (res.lines || []).map(ln => ({
        productId: ln.productId,
        productDescription: ln.productDescription,
        unitsPerCase: (ln.unitsPerCase ? String(ln.unitsPerCase) : ""),
        permanentIncrease: !!ln.permanentIncrease,

        cur_unitCaseCost: (ln.cur_unitCaseCost ? String(ln.cur_unitCaseCost) : ""),
        cur_qtyCaseDeal: (ln.cur_qtyCaseDeal ? String(ln.cur_qtyCaseDeal) : ""),

        m1_unitCaseCost: (ln.m1_unitCaseCost ? String(ln.m1_unitCaseCost) : ""),
        m1_qtyCaseDeal: (ln.m1_qtyCaseDeal ? String(ln.m1_qtyCaseDeal) : ""),

        m2_unitCaseCost: (ln.m2_unitCaseCost ? String(ln.m2_unitCaseCost) : ""),
        m2_qtyCaseDeal: (ln.m2_qtyCaseDeal ? String(ln.m2_qtyCaseDeal) : ""),

        m3_unitCaseCost: (ln.m3_unitCaseCost ? String(ln.m3_unitCaseCost) : ""),
        m3_qtyCaseDeal: (ln.m3_qtyCaseDeal ? String(ln.m3_qtyCaseDeal) : "")
      }));

      renderBatch();
      $("batchMsg").textContent = `Loaded last submitted batch (${res.batchId})`;
    } catch (e) {
      console.warn("Could not load latest batch:", e.message);
    }
  }

  /* -------- Signup / Login -------- */
  async function doSignup(){
    try {
      const firstName = $("firstName").value.trim();
      const lastName  = $("lastName").value.trim();
      const phone     = $("phone").value.trim();
      const pin       = $("pin").value.trim();

      const vSel = $("vendorSelect").value;
      let payload = { firstName, lastName, phone, pin };

      if (vSel === "__OTHER__") {
        payload.vendorName = $("vendorOther").value.trim();
        if (!payload.vendorName) return alert("Please type your vendor name.");
      } else {
        payload.vendorId = vSel;
        if (!payload.vendorId) return alert("Please select your vendor.");
      }

      const res = await apiPost("/rep/signup", payload, false);
      saveUser(res.user);
      saveToken(res.token);

      alert(`Account created!\nYour username is: ${res.user.username}`);
      renderAuthState();

      await loadLatestBatchIntoTable();
    } catch (e) {
      alert(e.message);
    }
  }

  async function doLogin(){
    try {
      const username = normalizeUsername($("loginUsername").value.trim());
      const pin = $("loginPin").value.trim();

      const res = await apiPost("/auth/login", { username, pin }, false);
      saveUser(res.user);
      saveToken(res.token);

      renderAuthState();
      await loadLatestBatchIntoTable();
    } catch (e) {
      alert(e.message);
    }
  }

  /* -------- Submit batch -------- */
  async function submitBatch(){
    if (!state.batch.length) return alert("Add at least one item.");

    for (const ln of state.batch) {
      if (!ln.unitsPerCase || Number(ln.unitsPerCase) <= 0) {
        return alert(`Units/Case required for SKU ${ln.productId}`);
      }
    }

    $("batchMsg").textContent = "Submitting...";
    try {
      const lines = state.batch.map(ln => ({
        ...ln,
        unitsPerCase: Number(ln.unitsPerCase),

        cur_unitCaseCost: Number(ln.cur_unitCaseCost || 0),
        cur_qtyCaseDeal: Number(ln.cur_qtyCaseDeal || 0),

        m1_unitCaseCost: Number(ln.m1_unitCaseCost || 0),
        m1_qtyCaseDeal: Number(ln.m1_qtyCaseDeal || 0),

        m2_unitCaseCost: Number(ln.m2_unitCaseCost || 0),
        m2_qtyCaseDeal: Number(ln.m2_qtyCaseDeal || 0),

        m3_unitCaseCost: Number(ln.m3_unitCaseCost || 0),
        m3_qtyCaseDeal: Number(ln.m3_qtyCaseDeal || 0),

        permanentIncrease: !!ln.permanentIncrease
      }));

      const res = await apiPost("/rep/batch/submit", { lines }, true);
      $("batchMsg").textContent = `Submitted batch ${res.batchId} (${res.lineCount} lines)`;

      state.batch = [];
      renderBatch();
    } catch (e) {
      $("batchMsg").textContent = e.message;
    }
  }

  /* -------- Init -------- */
  setBatchMonthHeaders();
  renderAuthState();
  loadVendors();

  $("vendorSelect").addEventListener("change", vendorUI);

  $("signupBtn").onclick = doSignup;
  $("loginBtn").onclick = doLogin;
  $("logoutBtn").onclick = logout;

  $("submitBatchBtn").onclick = submitBatch;
  $("clearBatchBtn").onclick = () => { state.batch = []; renderBatch(); $("batchMsg").textContent = ""; };

  wireBatchHandlers();

  // Button search still works
  $("searchBtn").onclick = () => searchInventory(false);

  // ✅ Dynamic search as you type
  $("searchQ").addEventListener("input", () => {
    debounceSearch(() => searchInventory(true), 250);
  });

  // Enter forces immediate search
  $("searchQ").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      clearTimeout(searchTimer);
      searchInventory(false);
    }
  });

  // If already logged in (token stored), auto-load latest batch
  if (getUser()?.role === "REP" && getToken()) {
    loadLatestBatchIntoTable();
  }
</script>
</body>
</html>
