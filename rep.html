<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rep Portal</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="nav">
    <div class="brand">Rep Portal</div>
    <div class="flex right">
      <span id="repWho" class="mono"></span>
      <button id="logoutBtn" class="hidden">Logout</button>
      <a href="index.html">Home</a>
    </div>
  </div>

  <div class="container">

    <!-- AUTH -->
    <div id="authCard" class="card">
      <h2>Sign in</h2>
      <div class="row">
        <div class="card" style="flex:1;min-width:280px">
          <h2>Login</h2>
          <div class="flex">
            <input id="loginUsername" placeholder="username (e.g., jsmith2)" />
            <input id="loginPin" placeholder="PIN" inputmode="numeric" />
            <button class="primary" id="loginBtn">Login</button>
          </div>
          <small>Username = first initial + last name (duplicates get a number).</small>
        </div>

        <div class="card" style="flex:1;min-width:280px">
          <h2>Create account</h2>
          <div class="flex">
            <input id="firstName" placeholder="First name" />
            <input id="lastName" placeholder="Last name" />
            <input id="phone" placeholder="Cell phone" />
          </div>

          <!-- Vendor selection -->
          <div style="margin-top:10px">
            <label for="vendorSelect"><small><b>Vendor</b> (select your company)</small></label>
            <select id="vendorSelect" style="width:100%; margin-top:6px;"></select>

            <div id="vendorOtherWrap" class="hidden" style="margin-top:10px">
              <label for="vendorOther"><small><b>If Other, type your vendor</b></small></label>
              <input id="vendorOther" placeholder="Type your vendor name..." style="width:100%; margin-top:6px;" />
            </div>

            <small>Don’t see your vendor? Choose <b>Other</b> and type it in.</small>
          </div>

          <div class="flex" style="margin-top:10px">
            <input id="pin" placeholder="Choose PIN (4+ digits)" inputmode="numeric" />
            <button class="primary" id="signupBtn">Create account</button>
          </div>
          <small>After signup you’ll see your exact username (e.g., jsmith2).</small>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appCard" class="card hidden">
      <h2>New Batch</h2>

      <div class="card">
        <h2>Add items</h2>

        <!-- Autocomplete search -->
        <div style="position:relative;max-width:820px">
          <div class="flex" style="align-items:flex-start">
            <input id="searchQ" placeholder="Search by description..." style="min-width:320px;flex:1" autocomplete="off" />
            <button id="searchBtn">Search</button>
            <span id="searchStatus"><small></small></span>
          </div>

          <div id="searchDropdown" class="hidden"
               style="position:absolute;left:0;right:0;top:44px;z-index:50;
                      background:#fff;border:1px solid #ddd;border-radius:10px;
                      box-shadow:0 10px 24px rgba(0,0,0,.12);max-height:320px;overflow:auto;">
          </div>
        </div>

        <!-- (kept for compatibility; not used) -->
        <div id="searchResults" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:14px">
        <h2>Batch Lines</h2>
        <div class="flex">
          <button id="submitBatchBtn" class="primary">Submit Batch</button>
          <button id="clearBatchBtn" class="danger">Clear</button>
          <small id="batchMsg"></small>
        </div>

        <!-- ✅ Updated: use class hidden instead of inline display -->
        <div id="batchLoading" class="hidden" style="margin:10px 0; font-weight:600;">
          <span class="spinner"></span> Loading latest batch...
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table class="table" id="batchTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Description</th>
                <th>Units/Case</th>
                <th>Permanent Price Increase?</th>

                <th id="h_m0_case"></th>
                <th id="h_m0_qty"></th>

                <th id="h_m1_case"></th>
                <th id="h_m1_qty"></th>

                <th id="h_m2_case"></th>
                <th id="h_m2_qty"></th>

                <th id="h_m3_case"></th>
                <th id="h_m3_qty"></th>

                <th></th>
              </tr>
            </thead>
            <tbody id="batchBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script src="app.js"></script>
<script>
  const state = { vendors: [], batch: [] };

  /* -------- Month headers -------- */
  function monthLabel(d) {
    return d.toLocaleString(undefined, { month: "short", year: "numeric" }); // e.g., "Feb 2026"
  }

  function setBatchMonthHeaders() {
    const now = new Date();
    const m0 = new Date(now.getFullYear(), now.getMonth(), 1);
    const m1 = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    const m2 = new Date(now.getFullYear(), now.getMonth() + 2, 1);
    const m3 = new Date(now.getFullYear(), now.getMonth() + 3, 1);
    const labels = [monthLabel(m0), monthLabel(m1), monthLabel(m2), monthLabel(m3)];

    const set = (id, text) => {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    };

    set("h_m0_case", `${labels[0]} Case Deal`);
    set("h_m0_qty",  `${labels[0]} Case Qty`);
    set("h_m1_case", `${labels[1]} Case Deal`);
    set("h_m1_qty",  `${labels[1]} Case Qty`);
    set("h_m2_case", `${labels[2]} Case Deal`);
    set("h_m2_qty",  `${labels[2]} Case Qty`);
    set("h_m3_case", `${labels[3]} Case Deal`);
    set("h_m3_qty",  `${labels[3]} Case Qty`);
  }

  /* -------- Vendor dropdown -------- */
  function vendorUI(){
    const val = $("vendorSelect").value;
    const isOther = (val === "__OTHER__");
    $("vendorOtherWrap").classList.toggle("hidden", !isOther);
    if (!isOther) $("vendorOther").value = "";
  }

  async function loadVendors(){
    const sel = $("vendorSelect");
    sel.innerHTML = "";
    const loading = document.createElement("option");
    loading.value = "";
    loading.textContent = "Loading vendors...";
    sel.appendChild(loading);

    try {
      const data = await apiPost("/vendors/list", {}, false);
      state.vendors = data.vendors || [];
    } catch {
      state.vendors = [];
    }

    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Select your vendor...";
    sel.appendChild(opt0);

    for (const v of state.vendors) {
      const o = document.createElement("option");
      o.value = v.vendorId;
      o.textContent = v.vendorName;
      sel.appendChild(o);
    }

    const other = document.createElement("option");
    other.value = "__OTHER__";
    other.textContent = "Other (add new)";
    sel.appendChild(other);

    vendorUI();
  }

  /* -------- Auth state -------- */
  function renderAuthState(){
    const user = getUser();
    const loggedIn = !!user && !!getToken();

    $("authCard").classList.toggle("hidden", loggedIn);
    $("appCard").classList.toggle("hidden", !loggedIn);
    $("logoutBtn").classList.toggle("hidden", !loggedIn);

    $("repWho").textContent = loggedIn ? `${user.username}${user.repId ? " ("+user.repId+")" : ""}` : "";
  }

  function logout(){
    clearToken();
    state.batch = [];
    renderBatch();

    $("batchMsg").textContent = "";
    $("searchQ").value = "";
    $("searchStatus").innerHTML = "<small></small>";
    closeDropdown();

    renderAuthState();
  }

  /* -------- Batch UI -------- */
  function isInBatch(productId){
    return state.batch.some(x => x.productId === productId);
  }

  function addToBatch(item){
    if (isInBatch(item.productId)) return;
    state.batch.push({
      productId: item.productId,
      productDescription: item.productDescription,
      unitsPerCase: "",
      permanentIncrease: false,

      cur_unitCaseCost: "",
      cur_qtyCaseDeal: "",

      m1_unitCaseCost: "",
      m1_qtyCaseDeal: "",

      m2_unitCaseCost: "",
      m2_qtyCaseDeal: "",

      m3_unitCaseCost: "",
      m3_qtyCaseDeal: ""
    });
    renderBatch();

    // keep dropdown tags accurate
    if (ac.open) renderDropdown(ac.items);
  }

  function renderBatch(){
    const tb = $("batchBody");
    tb.innerHTML = "";
    state.batch.forEach((ln, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${ln.productId}</td>
        <td>${ln.productDescription}</td>

        <td><input value="${ln.unitsPerCase}" data-k="unitsPerCase" data-i="${idx}" style="min-width:110px"></td>

        <td style="text-align:center">
          <input type="checkbox" ${ln.permanentIncrease ? "checked":""} data-k="permanentIncrease" data-i="${idx}">
        </td>

        <td><input value="${ln.cur_unitCaseCost}" data-k="cur_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.cur_qtyCaseDeal}" data-k="cur_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><input value="${ln.m1_unitCaseCost}" data-k="m1_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.m1_qtyCaseDeal}" data-k="m1_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><input value="${ln.m2_unitCaseCost}" data-k="m2_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.m2_qtyCaseDeal}" data-k="m2_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><input value="${ln.m3_unitCaseCost}" data-k="m3_unitCaseCost" data-i="${idx}" style="min-width:120px"></td>
        <td><input value="${ln.m3_qtyCaseDeal}" data-k="m3_qtyCaseDeal" data-i="${idx}" style="min-width:110px"></td>

        <td><button class="danger" data-del="${idx}">Remove</button></td>
      `;
      tb.appendChild(tr);
    });
  }

  function wireBatchHandlers(){
    $("batchBody").addEventListener("input", (e) => {
      const t = e.target;
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if (!Number.isInteger(i) || !k) return;
      state.batch[i][k] = t.value;

      // update dropdown badges live
      if (ac.open) renderDropdown(ac.items);
    });

    $("batchBody").addEventListener("change", (e) => {
      const t = e.target;
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if (!Number.isInteger(i) || !k) return;
      if (t.type === "checkbox") state.batch[i][k] = t.checked;

      if (ac.open) renderDropdown(ac.items);
    });

    $("batchBody").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;
      const i = Number(btn.dataset.del);
      state.batch.splice(i, 1);
      renderBatch();

      // If dropdown is open, re-render so "Already in batch" updates
      if (ac.open) renderDropdown(ac.items);
    });
  }

  /* -------- Autocomplete dropdown (Google-like) -------- */
  let searchTimer = null;
  let searchAbort = null;

  const ac = {
    items: [],
    activeIndex: -1,
    open: false
  };

  function debounce(fn, delay = 200) {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(fn, delay);
  }

  function openDropdown() {
    $("searchDropdown").classList.remove("hidden");
    ac.open = true;
  }

  function closeDropdown() {
    $("searchDropdown").classList.add("hidden");
    $("searchDropdown").innerHTML = "";
    ac.open = false;
    ac.items = [];
    ac.activeIndex = -1;
  }

  function setActive(index) {
    ac.activeIndex = index;
    const nodes = $("searchDropdown").querySelectorAll("[data-ac-index]");
    nodes.forEach(n => n.classList.remove("ac-active"));
    const active = $("searchDropdown").querySelector(`[data-ac-index="${index}"]`);
    if (active) {
      active.classList.add("ac-active");
      active.scrollIntoView({ block: "nearest" });
    }
  }

  function addFromAutocomplete(item) {
    if (!item) return;

    if (isInBatch(item.productId)) {
      $("searchStatus").innerHTML = "<small>Already in batch.</small>";
      return;
    }

    addToBatch(item);

    // Optional UX: clear and close after add
    $("searchQ").value = "";
    $("searchStatus").innerHTML = "<small>Added.</small>";
    closeDropdown();
    $("searchQ").focus();
  }

  function ensureAutocompleteStyle() {
    if (document.getElementById("acStyle")) return;

    const s = document.createElement("style");
    s.id = "acStyle";
    s.textContent = `
      .ac-row{padding:10px 12px;cursor:pointer;display:flex;gap:10px;align-items:flex-start}
      .ac-row:hover{background:rgba(0,0,0,.06)}
      .ac-active{background:rgba(0,0,0,.10)}
      .ac-sku{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; min-width:90px}
      .ac-desc{flex:1}
      .ac-badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ddd;opacity:.85;white-space:nowrap}
      .ac-disabled{opacity:.55;cursor:not-allowed}
    `;
    document.head.appendChild(s);
  }

  function renderDropdown(items) {
    ensureAutocompleteStyle();

    const dd = $("searchDropdown");
    dd.innerHTML = "";

    if (!items.length) {
      dd.innerHTML = `<div style="padding:10px"><small>No matches.</small></div>`;
      openDropdown();
      ac.items = [];
      ac.activeIndex = -1;
      return;
    }

    items.forEach((it, idx) => {
      const inBatch = isInBatch(it.productId);

      const row = document.createElement("div");
      row.className = "ac-row" + (inBatch ? " ac-disabled" : "");
      row.setAttribute("data-ac-index", String(idx));

      row.innerHTML = `
        <div class="ac-sku">${it.productId}</div>
        <div class="ac-desc">${it.productDescription}</div>
        ${
          inBatch
            ? `<div class="ac-badge">Already in batch</div>`
            : `<div class="ac-badge">↵ Add</div>`
        }
      `;

      row.addEventListener("mouseenter", () => setActive(idx));

      row.addEventListener("mousedown", (e) => {
        e.preventDefault();
        if (inBatch) {
          $("searchStatus").innerHTML = "<small>Already in batch.</small>";
          return;
        }
        addFromAutocomplete(it);
      });

      dd.appendChild(row);
    });

    ac.items = items;
    openDropdown();

    // Keep a sensible active row (prefer first non-disabled)
    let firstPick = 0;
    for (let i = 0; i < items.length; i++) {
      if (!isInBatch(items[i].productId)) { firstPick = i; break; }
    }
    setActive(firstPick);
  }

  async function fetchInventoryMatches(q) {
    if (searchAbort) searchAbort.abort();
    searchAbort = new AbortController();

    const headers = { "Content-Type": "application/json" };
    const t = getToken();
    if (t) headers["Authorization"] = "Bearer " + t;

    const res = await fetch(API_BASE + "/inventory/search", {
      method: "POST",
      headers,
      body: JSON.stringify({ q }),
      signal: searchAbort.signal
    });

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Search failed");
    return data.items || [];
  }

  async function autocompleteSearch() {
    const q = $("searchQ").value.trim();

    if (q.length < 2) {
      $("searchStatus").innerHTML = "<small>Type 2+ characters…</small>";
      closeDropdown();
      return;
    }

    $("searchStatus").innerHTML = "<small>Searching…</small>";

    try {
      const items = await fetchInventoryMatches(q);
      $("searchStatus").innerHTML = `<small>${items.length} result(s)</small>`;
      renderDropdown(items);
    } catch (err) {
      if (err.name === "AbortError") return;
      $("searchStatus").innerHTML = `<small class="badge bad">${err.message}</small>`;
      closeDropdown();
    }
  }

  function moveActive(delta) {
    if (!ac.open || !ac.items.length) return;

    let idx = ac.activeIndex;
    for (let step = 0; step < ac.items.length; step++) {
      idx = Math.max(0, Math.min(ac.items.length - 1, idx + delta));
      if (!isInBatch(ac.items[idx].productId)) break;

      if ((delta > 0 && idx === ac.items.length - 1) || (delta < 0 && idx === 0)) break;
    }
    setActive(idx);
  }

  /* -------- Auto-load latest submitted batch on login -------- */
  async function loadLatestBatchIntoTable() {
    const loadingEl = $("batchLoading");
    const submitBtn = $("submitBatchBtn");

    try {
      // ✅ show loading + disable submit
      loadingEl.classList.remove("hidden");
      if (submitBtn) submitBtn.disabled = true;

      // ✅ lock to current month (recommended, matches overwrite-by-month)
      const now = new Date();
      const batchMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;

      const res = await apiPost("/rep/batch/latest", { batchMonth }, true);

      if (!res.ok) throw new Error(res.error || "Failed to load latest batch");
      if (!res.hasBatch) {
        $("batchMsg").textContent = "";
        return;
      }

      state.batch = (res.lines || []).map(ln => ({
        productId: ln.productId,
        productDescription: ln.productDescription,
        unitsPerCase: (ln.unitsPerCase ? String(ln.unitsPerCase) : ""),
        permanentIncrease: !!ln.permanentIncrease,

        cur_unitCaseCost: (ln.cur_unitCaseCost ? String(ln.cur_unitCaseCost) : ""),
        cur_qtyCaseDeal: (ln.cur_qtyCaseDeal ? String(ln.cur_qtyCaseDeal) : ""),

        m1_unitCaseCost: (ln.m1_unitCaseCost ? String(ln.m1_unitCaseCost) : ""),
        m1_qtyCaseDeal: (ln.m1_qtyCaseDeal ? String(ln.m1_qtyCaseDeal) : ""),

        m2_unitCaseCost: (ln.m2_unitCaseCost ? String(ln.m2_unitCaseCost) : ""),
        m2_qtyCaseDeal: (ln.m2_qtyCaseDeal ? String(ln.m2_qtyCaseDeal) : ""),

        m3_unitCaseCost: (ln.m3_unitCaseCost ? String(ln.m3_unitCaseCost) : ""),
        m3_qtyCaseDeal: (ln.m3_qtyCaseDeal ? String(ln.m3_qtyCaseDeal) : "")
      }));

      renderBatch();
      $("batchMsg").textContent = `Loaded latest batch (${res.batchId})`;
      if (ac.open) renderDropdown(ac.items);

    } catch (e) {
      console.warn("Could not load latest batch:", e.message);
    } finally {
      // ✅ hide loading + enable submit
      loadingEl.classList.add("hidden");
      if (submitBtn) submitBtn.disabled = false;
    }
  }

  /* -------- Signup / Login -------- */
  async function doSignup(){
    try {
      const firstName = $("firstName").value.trim();
      const lastName  = $("lastName").value.trim();
      const phone     = $("phone").value.trim();
      const pin       = $("pin").value.trim();

      const vSel = $("vendorSelect").value;
      let payload = { firstName, lastName, phone, pin };

      if (vSel === "__OTHER__") {
        payload.vendorName = $("vendorOther").value.trim();
        if (!payload.vendorName) return alert("Please type your vendor name.");
      } else {
        payload.vendorId = vSel;
        if (!payload.vendorId) return alert("Please select your vendor.");
      }

      const res = await apiPost("/rep/signup", payload, false);
      saveUser(res.user);
      saveToken(res.token);

      alert(`Account created!\nYour username is: ${res.user.username}`);
      renderAuthState();

      await loadLatestBatchIntoTable();
    } catch (e) {
      alert(e.message);
    }
  }

  async function doLogin(){
    try {
      const username = normalizeUsername($("loginUsername").value.trim());
      const pin = $("loginPin").value.trim();

      const res = await apiPost("/auth/login", { username, pin }, false);
      saveUser(res.user);
      saveToken(res.token);

      renderAuthState();
      await loadLatestBatchIntoTable();
    } catch (e) {
      alert(e.message);
    }
  }

  /* -------- Submit batch -------- */
  async function submitBatch(){
    if (!state.batch.length) return alert("Add at least one item.");

    for (const ln of state.batch) {
      if (!ln.unitsPerCase || Number(ln.unitsPerCase) <= 0) {
        return alert(`Units/Case required for SKU ${ln.productId}`);
      }
    }

    $("batchMsg").textContent = "Submitting...";
    try {
      const lines = state.batch.map(ln => ({
        ...ln,
        unitsPerCase: Number(ln.unitsPerCase),

        cur_unitCaseCost: Number(ln.cur_unitCaseCost || 0),
        cur_qtyCaseDeal: Number(ln.cur_qtyCaseDeal || 0),

        m1_unitCaseCost: Number(ln.m1_unitCaseCost || 0),
        m1_qtyCaseDeal: Number(ln.m1_qtyCaseDeal || 0),

        m2_unitCaseCost: Number(ln.m2_unitCaseCost || 0),
        m2_qtyCaseDeal: Number(ln.m2_qtyCaseDeal || 0),

        m3_unitCaseCost: Number(ln.m3_unitCaseCost || 0),
        m3_qtyCaseDeal: Number(ln.m3_qtyCaseDeal || 0),

        permanentIncrease: !!ln.permanentIncrease
      }));

      const res = await apiPost("/rep/batch/submit", { lines }, true);
      $("batchMsg").textContent = `Submitted batch ${res.batchId} (${res.lineCount} lines)`;

      state.batch = [];
      renderBatch();
      closeDropdown();
      $("searchQ").value = "";
      $("searchStatus").innerHTML = "<small></small>";

    } catch (e) {
      $("batchMsg").textContent = e.message;
    }
  }

  /* -------- Init -------- */
  setBatchMonthHeaders();
  renderAuthState();
  loadVendors();

  $("vendorSelect").addEventListener("change", vendorUI);

  $("signupBtn").onclick = doSignup;
  $("loginBtn").onclick = doLogin;
  $("logoutBtn").onclick = logout;

  $("submitBatchBtn").onclick = submitBatch;
  $("clearBatchBtn").onclick = () => {
    state.batch = [];
    renderBatch();
    $("batchMsg").textContent = "";
    if (ac.open) renderDropdown(ac.items);
  };

  wireBatchHandlers();

  // Search button: immediate search
  $("searchBtn").onclick = () => {
    clearTimeout(searchTimer);
    autocompleteSearch();
  };

  // Search-as-you-type
  $("searchQ").addEventListener("input", () => {
    debounce(() => autocompleteSearch(), 200);
  });

  // Keyboard navigation
  $("searchQ").addEventListener("keydown", (e) => {
    if (!ac.open) {
      if (e.key === "Enter") {
        e.preventDefault();
        clearTimeout(searchTimer);
        autocompleteSearch();
      }
      return;
    }

    if (e.key === "ArrowDown") {
      e.preventDefault();
      moveActive(+1);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      moveActive(-1);
    } else if (e.key === "Enter") {
      e.preventDefault();
      const item = ac.items[ac.activeIndex];
      if (!item) return;

      if (isInBatch(item.productId)) {
        $("searchStatus").innerHTML = "<small>Already in batch.</small>";
        return;
      }
      addFromAutocomplete(item);
    } else if (e.key === "Escape") {
      e.preventDefault();
      closeDropdown();
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener("mousedown", (e) => {
    if (!ac.open) return;
    const dd = $("searchDropdown");
    const q = $("searchQ");
    if (dd.contains(e.target) || q.contains(e.target)) return;
    closeDropdown();
  });

  // Close on blur (delay so mousedown on item still works)
  $("searchQ").addEventListener("blur", () => {
    setTimeout(() => {
      if (!document.activeElement || document.activeElement.id !== "searchQ") closeDropdown();
    }, 120);
  });

  // If already logged in (token stored), auto-load latest batch
  if (getUser()?.role === "REP" && getToken()) {
    loadLatestBatchIntoTable();
  }
</script>
</body>
</html>
